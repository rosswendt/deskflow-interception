<CPackWiXPatch>
  <!-- Service for deskflow-daemon.exe -->
  <CPackWiXFragment Id="CM_CP_deskflow_daemon.exe">
    <ServiceInstall
      Id="ServiceInstall"
      Name="Deskflow"
      DisplayName="Deskflow"
      Description="Runs the Core process on secure desktops (UAC prompts, login screen, etc)."
      ErrorControl="normal"
      Start="auto"
      Type="ownProcess">
      <util:ServiceConfig
        ResetPeriodInDays="1"
        RestartServiceDelayInSeconds="1"
        FirstFailureActionType="restart"
        SecondFailureActionType="restart"
        ThirdFailureActionType="none"/>
    </ServiceInstall>
    <ServiceControl Id="ServiceControl" Name="Deskflow" Remove="uninstall" Start="install" Stop="both"/>
    <RemoveFile Id="RmOldLog" On="install" Name="deskflow-daemon.log"/>
  </CPackWiXFragment>

  <!-- Firewall exceptions -->
  <CPackWiXFragment Id="CM_CP_deskflow_server.exe">
    <firewall:FirewallException
      Id="ServerFirewallException"
      Name="Deskflow Server"
      Program="[INSTALL_ROOT]deskflow-server.exe"
      Scope="any"/>
  </CPackWiXFragment>

  <CPackWiXFragment Id="CM_CP_deskflow_client.exe">
    <firewall:FirewallException
      Id="ClientFirewallException"
      Name="Deskflow Client"
      Program="[INSTALL_ROOT]deskflow-client.exe"
      Scope="any"/>
  </CPackWiXFragment>

  <!-- Product-level UI and custom actions -->
  <CPackWiXFragment Id="#PRODUCT">
    <!-- Custom action DLL built by CMake target 'wix-custom' -->
    <Binary Id="CustomDLL" SourceFile="@CMAKE_CURRENT_BINARY_DIR@/wix-custom.dll"/>

    <!-- Exit dialog "Run now" checkbox -->
    <UI>
      <Publish Dialog="ExitDialog"
               Control="Finish"
               Event="DoAction"
               Value="RunDeskflow"
               Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed"/>
      <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1"/>
      <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Run Deskflow when finished"/>
    </UI>

    <!-- VC++ redist check is done inside the custom action (reads x64 registry itself) -->
    <CustomAction Id="CheckVCRedist"
                  BinaryRef="CustomDLL"
                  DllEntry="CheckVCRedist"
                  Execute="immediate"/>

    <CustomAction Id="ShowVCRedistError"
                  Error="Microsoft Visual C++ Redistributable v@REQUIRED_MSVC_RUNTIME_MAJOR@.@REQUIRED_MSVC_RUNTIME_MINOR@ or later is required. Please download and install the latest version and then restart the installation. See our documentation for instructions."/>

    <!-- Launch app after install -->
    <CustomAction Id="RunDeskflow"
                  ExeCommand="[INSTALL_ROOT]deskflow.exe"
                  Directory="INSTALL_ROOT"
                  Execute="immediate"
                  Impersonate="yes"
                  Return="asyncNoWait"/>

    <!-- WiX 4/6: use Condition attribute on <Custom> -->
    <InstallExecuteSequence>
      <Custom Action="CheckVCRedist" Before="InstallInitialize" Condition="NOT Installed"/>
      <Custom Action="ShowVCRedistError" Before="InstallInitialize" Condition="NOT Installed AND (VC_REDIST_VERSION_OK &lt;&gt; 1)"/>
    </InstallExecuteSequence>
  </CPackWiXFragment>
</CPackWiXPatch>
